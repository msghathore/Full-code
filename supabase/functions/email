import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
import { corsHeaders } from '../_shared/cors.ts'

serve(async (req: Request) => {
  // Handle CORS preflight requests
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    // Initialize Supabase client
    const supabaseClient = createClient(
      Deno.env.get('SUPABASE_URL') ?? '',
      Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? ''
    );

    // Get authorization header
    const authHeader = req.headers.get('Authorization');
    if (!authHeader) {
      return new Response(
        JSON.stringify({ error: 'Missing Authorization header' }),
        { 
          status: 401,
          headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        }
      );
    }

    // Verify JWT token
    const token = authHeader.split(' ')[1];
    const { data: { user }, error: authError } = await supabaseClient.auth.getUser(token);
    
    if (authError || !user) {
      return new Response(
        JSON.stringify({ error: 'Invalid or expired token' }),
        { 
          status: 401,
          headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        }
      );
    }

    // Get user metadata to determine access level
    const userMetadata = user.user_metadata || {};
    const userRole = userMetadata.role;

    // Handle different request methods
    if (req.method === 'POST') {
      // Send notification for appointment
      const { appointmentId, type } = await req.json();

      // Validate required fields
      if (!appointmentId) {
        return new Response(
          JSON.stringify({ error: 'Missing required field: appointmentId' }),
          { 
            status: 400,
            headers: { ...corsHeaders, 'Content-Type': 'application/json' }
          }
        );
      }

      // Get appointment details
      const { data: appointmentData, error: appointmentError } = await supabaseClient
        .from('appointments')
        .select(`
          *,
          customer:customers(*),
          staff:staff(*),
          service:services(*)
        `)
        .eq('id', appointmentId)
        .single();

      if (appointmentError || !appointmentData) {
        return new Response(
          JSON.stringify({ error: 'Appointment not found' }),
          { 
            status: 404,
            headers: { ...corsHeaders, 'Content-Type': 'application/json' }
          }
        );
      }

      // Check if user has permission to send notifications for this appointment
      if (userRole !== 'admin' && userRole !== 'manager' && appointmentData.staff_id !== userMetadata.staff_id) {
        return new Response(
          JSON.stringify({ error: 'Insufficient permissions to send notification for this appointment' }),
          { 
            status: 403,
            headers: { ...corsHeaders, 'Content-Type': 'application/json' }
          }
        );
      }

      // Format appointment time for display
      const appointmentDate = new Date(appointmentData.appointment_date + 'T' + appointmentData.appointment_time);
      const formattedDate = appointmentDate.toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      const formattedTime = appointmentDate.toLocaleTimeString('en-US', {
        hour: '2-digit',
        minute: '2-digit'
      });

      // Create email subject and content based on notification type
      let subject = '';
      let content = '';

      if (type === 'confirmation') {
        subject = `Your Appointment Confirmation - ${appointmentData.service.name}`;
        content = `
          Dear ${appointmentData.customer.first_name} ${appointmentData.customer.last_name},

          This is a confirmation for your upcoming appointment:

          Service: ${appointmentData.service.name}
          Staff Member: ${appointmentData.staff.first_name} ${appointmentData.staff.last_name}
          Date: ${formattedDate}
          Time: ${formattedTime}
          Amount: $${appointmentData.total_amount}

          Please arrive 10 minutes early for check-in.

          If you need to reschedule or cancel, please contact us at least 24 hours in advance.

          Thank you for choosing Zavira Salon!

          Best regards,
          The Zavira Salon Team
        `;
      } else if (type === 'reminder') {
        subject = `Appointment Reminder - ${appointmentData.service.name} Tomorrow`;
        content = `
          Dear ${appointmentData.customer.first_name} ${appointmentData.customer.last_name},

          This is a friendly reminder about your upcoming appointment tomorrow:

          Service: ${appointmentData.service.name}
          Staff Member: ${appointmentData.staff.first_name} ${appointmentData.staff.last_name}
          Date: ${formattedDate}
          Time: ${formattedTime}
          Amount: $${appointmentData.total_amount}

          Please arrive 10 minutes early for check-in.

          If you need to reschedule or cancel, please contact us as soon as possible.

          Thank you for choosing Zavira Salon!

          Best regards,
          The Zavira Salon Team
        `;
      } else if (type === 'cancellation') {
        subject = `Appointment Cancellation - ${appointmentData.service.name}`;
        content = `
          Dear ${appointmentData.customer.first_name} ${appointmentData.customer.last_name},

          Your appointment has been cancelled:

          Service: ${appointmentData.service.name}
          Staff Member: ${appointmentData.staff.first_name} ${appointmentData.staff.last_name}
          Date: ${formattedDate}
          Time: ${formattedTime}

          If you need to schedule a new appointment, please contact us or use our online booking system.

          We apologize for any inconvenience this may cause.

          Best regards,
          The Zavira Salon Team
        `;
      } else if (type === 'payment') {
        subject = `Payment Receipt - ${appointmentData.service.name}`;
        content = `
          Dear ${appointmentData.customer.first_name} ${appointmentData.customer.last_name},

          Thank you for your payment. Here are the details:

          Service: ${appointmentData.service.name}
          Staff Member: ${appointmentData.staff.first_name} ${appointmentData.staff.last_name}
          Date: ${formattedDate}
          Time: ${formattedTime}
          Amount Paid: $${appointmentData.total_amount}

          Your payment has been successfully processed.

          If you have any questions about your payment, please contact us.

          Thank you for choosing Zavira Salon!

          Best regards,
          The Zavira Salon Team
        `;
      } else {
        return new Response(
          JSON.stringify({ error: 'Invalid notification type' }),
          { 
            status: 400,
            headers: { ...corsHeaders, 'Content-Type': 'application/json' }
          }
        );
      }

      // In a real application, you would integrate with an email service like SendGrid, Mailgun, etc.
      // For this example, we'll just log the email that would be sent
      console.log(`Sending email to ${appointmentData.customer.email}`);
      console.log(`Subject: ${subject}`);
      console.log(`Content: ${content}`);

      // Mark notification as sent in the database (you would need to add a notifications table)
      // This is just a placeholder for the actual implementation
      // await supabaseClient
      //   .from('notifications')
      //   .insert([
      //     {
      //       appointment_id: appointmentId,
      //       type: type,
      //       sent_to: appointmentData.customer.email,
      //       sent_at: new Date().toISOString()
      //     }
      //   ]);

      return new Response(
        JSON.stringify({ 
          success: true,
          message: `Email notification sent to ${appointmentData.customer.email}`
        }),
        { 
          status: 200,
          headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        }
      );
    }

    // If we reach here, the request method is not supported
    return new Response(
      JSON.stringify({ error: `Method ${req.method} not allowed` }),
      { 
        status: 405,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      }
    );

  } catch (error) {
    console.error('Email notification error:', error);
    return new Response(
      JSON.stringify({ error: 'Email notification failed' }),
      { 
        status: 500,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      }
    );
  }
})